!function(a,b,c,d){a.widget("ui.triggeredAutocomplete",a.extend(!0,{},a.ui.autocomplete.prototype,{options:{trigger:"@",allowDuplicates:!1},_create:function(){var b=this;this.id_map=new Object,this.stopIndex=-1,this.stopLength=-1,this.contents="",this.cursorPos=0,this.element.bind("keydown.autocomplete.fix",function(c){switch(c.keyCode){case a.ui.keyCode.ESCAPE:b.close(c),c.stopImmediatePropagation();break;case a.ui.keyCode.UP:case a.ui.keyCode.DOWN:b.menu.element.is(":visible")||c.stopImmediatePropagation()}});var c=this.element.attr("id_map");c&&(this.id_map=jQuery.parseJSON(c)),this.ac=a.ui.autocomplete.prototype,this.ac._create.apply(this,arguments),this.updateHidden(),this.options.select=function(a,c){var d=b.contents,e=b.cursorPos,f=d.substring(e,d.length),g=d.substring(0,e);g=g.substring(0,g.lastIndexOf(b.options.trigger));var h=b.element.scrollTop();this.value=g+b.options.trigger+c.item.username+" "+f,b.element.scrollTop(h),b.id_map[c.item.label]=c.item.value,b.updateHidden();var i=g.length+b.options.trigger.length+c.item.username.length+2;if(this.createTextRange){var j=this.createTextRange();j.move("character",i),j.select()}else this.setSelectionRange&&this.setSelectionRange(i,i);return!1},this.options.focus=function(a,b){return!1},this.menu.options.blur=function(a,b){return!1},this.element.focus(function(){b.updateHidden()}),this.element.change(function(){b.updateHidden()})},_renderItem:function(b,c){return c.img!=d?a("<li></li>").data("item.autocomplete",c).append("<a><img src='"+c.img+"' /><span>"+c.label+" <span class='small-mention'>@"+c.username+"</span></span></a>").appendTo(b):a("<li></li>").data("item.autocomplete",c).append(a("<a></a>").text(c.label)).appendTo(b)},_move:function(a,b){return this.menu.element.is(":visible")?this.menu.first()&&/^previous/.test(a)||this.menu.last()&&/^next/.test(a)?void this.menu.deactivate():void this.menu[a](b):void this.search(null,b)},search:function(a,b){var c=this.element.val(),d=this.getCursor();this.contents=c,this.cursorPos=d;c.substring(c.lastIndexOf(this.options.trigger)-1,d),new RegExp("\\B\\"+this.options.trigger+"([\\w\\-]+)");if(c.indexOf(this.options.trigger)>=0){c=c.substring(0,d);var g=c.substring(c.lastIndexOf(this.options.trigger)+1,c.length);if(this.stopIndex==c.lastIndexOf(this.options.trigger)&&g.length>this.stopLength&&(g=""),g.length>0)return this.updateHidden(),this._search(g);this.close()}},_initSource:function(){var c,d,b=this;a.isArray(this.options.source)?(c=this.options.source,this.source=function(b,d){d(a.ui.autocomplete.filter(c,b.term))}):"string"==typeof this.options.source?(d=this.options.source,this.source=function(c,e){b.xhr&&b.xhr.abort(),b.xhr=a.ajax({url:d,data:c,dataType:"json",success:function(d){null!=d?(e(a.map(d,function(a){if("string"==typeof a?label=a:label=a.label,!b.id_map[label]||b.options.allowDuplicates)return a})),b.stopLength=-1,b.stopIndex=-1):(b.stopLength=c.term.length,b.stopIndex=b.contents.lastIndexOf(b.options.trigger),b.close())}})}):this.source=this.options.source},destroy:function(){a.Widget.prototype.destroy.call(this)},getCursor:function(){var a=this.element[0];if(a.selectionStart)return a.selectionStart;if(a.ownerDocument.selection){var b=a.ownerDocument.selection.createRange();if(!b)return 0;var c=a.createTextRange(),d=c.duplicate();return c.moveToBookmark(b.getBookmark()),d.setEndPoint("EndToStart",c),d.text.length}},updateHidden:function(){var b=this.options.trigger,c=this.element.scrollTop(),d=this.element.val();for(var e in this.id_map){var f=b+e;f=f.replace(/[^a-zA-Z 0-9@]+/g,"\\$&");var g=new RegExp(f,"g"),h=d;d=d.replace(g,b+"["+this.id_map[e]+"]"),h==d&&delete this.id_map[e]}a(this.options.hidden).val(d),this.element.scrollTop(c)}}))}(jQuery,window,document);